DROP SCHEMA airline cascade; 
CREATE SCHEMA airline; 

--- PLANES 

DROP TABLE IF EXISTS planes CASCADE; 
CREATE TABLE planes (
	name VARCHAR(64) NOT NULL,
	model VARCHAR(64) NOT NULL,
	registration_number CHAR(6), 
	first_class_capacity SMALLINT NOT NULL,
	business_class_capacity SMALLINT NOT NULL,
	cost_per_hour SMALLINT NOT NULL, 
	CONSTRAINT pk_planes PRIMARY KEY (registration_number),
	CONSTRAINT ck_fc_cap CHECK (first_class_capacity BETWEEN 0 AND 48), 
	CONSTRAINT ck_bs_cap CHECK (business_class_capacity BETWEEN 0 AND 144),
	CONSTRAINT ck_cph CHECK (cost_per_hour BETWEEN 0 AND 50000)

);

--- SEATS 

DROP TABLE IF EXISTS seats; 
CREATE TABLE seats (
    row SMALLINT NOT NULL,
    "column" CHAR(1) NOT NULL,
    class VARCHAR(16) NOT NULL, 
    plane_id CHAR(6) NOT NULL,
    CONSTRAINT ck_row CHECK (
        (class = 'first' AND row > 0 AND row <= 12 AND "column" IN ('A', 'B', 'C', 'D')) OR
        (class = 'business' AND row > 12 AND row <= 36 AND "column" IN ('A', 'B', 'C', 'D', 'E', 'F'))
    ),
    CONSTRAINT ck_type CHECK (class IN ('first', 'business')), 
    CONSTRAINT pk_plane_seat PRIMARY KEY (row, "column", plane_id), 
    CONSTRAINT fk_plane FOREIGN KEY (plane_id) REFERENCES planes(registration_number) ON UPDATE CASCADE ON DELETE CASCADE

);


--- AIRPORT 
DROP TABLE IF EXISTS airport; 
CREATE TABLE airport (
	name VARCHAR(64) NOT NULL,
	iata_code CHAR(3) NOT NULL, 
	city VARCHAR(64) NOT NULL,
	country VARCHAR(64) NOT NULL,
	timezone VARCHAR(64) NOT NULL,
	CONSTRAINT pk_airport PRIMARY KEY (iata_code)
); 

--- FLIGHTS 
DROP TABLE IF EXISTS flights;

CREATE TABLE flights (
    	flight_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    	flight_number VARCHAR(10) NOT NULL, 
    	plane_id CHAR(6) NOT NULL,
    	origin CHAR(3) NOT NULL,
    	destination CHAR(3) NOT NULL,
    	departure_date TIMESTAMPTZ NOT NULL,
   	arrival_time TIMESTAMPTZ NOT NULL,
   	trip_type VARCHAR(8),
   	CONSTRAINT ck_trip_type CHECK (trip_type IN ('Outbound', 'Return')),
    	CONSTRAINT fk_origin FOREIGN KEY (origin) REFERENCES airport(iata_code) ON UPDATE CASCADE ON DELETE CASCADE,
    	CONSTRAINT fk_destination FOREIGN KEY (destination) REFERENCES airport(iata_code) ON UPDATE CASCADE ON DELETE CASCADE,
    	CONSTRAINT fk_plane FOREIGN KEY (plane_id) REFERENCES planes(registration_number) ON UPDATE CASCADE ON DELETE CASCADE
);


--- PLANE SEATINGS 
DROP TABLE IF EXISTS plane_seatings; 
CREATE TABLE plane_seatings (
	seat_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	seat_row SMALLINT NOT NULL,
	seat_column CHAR(1) NOT NULL,
	plane_id CHAR(6) NOT NULL, 
	flight_id INT NOT NULL,
	person_id CHAR(11) DEFAULT NULL,
	CONSTRAINT uq_seats UNIQUE(seat_row, seat_column, plane_id, flight_id), 
   	CONSTRAINT fk_seats_planes FOREIGN KEY (seat_row, seat_column, plane_id) REFERENCES seats (row, "column", plane_id) ON UPDATE CASCADE ON DELETE CASCADE,
  	CONSTRAINT fk_flights_seats FOREIGN KEY (flight_id) REFERENCES flights (flight_id) ON UPDATE CASCADE ON DELETE CASCADE
); 
	

--- PEOPLE 
DROP TABLE IF EXISTS people;
CREATE TABLE people (
	first_name VARCHAR(128), 
	last_name VARCHAR(128),
	passport_nation CHAR(3),
	passport_number CHAR(8),
	person_id CHAR(11) GENERATED ALWAYS AS (passport_nation || passport_number) STORED, 
	CONSTRAINT people_pk PRIMARY KEY (person_id),
	CONSTRAINT uq_people_nation UNIQUE (passport_nation, passport_number)
); 


--- RESERVATION ; 
DROP TABLE IF EXISTS reservations;
CREATE TABLE reservations (
    	reservation_code CHAR(10) PRIMARY KEY, 
    	booker_id CHAR(11) NOT NULL, 
    	FOREIGN KEY (booker_id) REFERENCES people(person_id) ON UPDATE CASCADE ON DELETE CASCADE
);

--- RESERVATION PASSENGER 
DROP TABLE IF EXISTS reservation_passengers;
CREATE TABLE reservation_passengers (
    	reservation_code CHAR(10),
    	person_id CHAR(11),
		CONSTRAINT rp_pk PRIMARY KEY(reservation_code, person_id),
		CONSTRAINT fk_person_reservation_pass FOREIGN KEY (person_id) REFERENCES people(person_id) ON UPDATE CASCADE ON DELETE CASCADE
);


--- TICKET PRICES 
DROP TABLE IF EXISTS ticket_prices; 
CREATE TABLE ticket_prices (
	flight_number CHAR(10) NOT NULL, 
	class VARCHAR(16) NOT NULL, 
	price SMALLINT NOT NULL, 
	CONSTRAINT pk_tik_prc PRIMARY KEY(flight_number, class),
	CONSTRAINT ck_price CHECK(price BETWEEN 0 AND 3000)
); 


--- RESERVATION FLIGHTS 
DROP TABLE IF EXISTS reservation_flghts;
CREATE TABLE reservation_flights(
	reservation_code CHAR(10), 
	flight_id SMALLINT, 
	CONSTRAINT pk_res_pass PRIMARY KEY (reservation_code, flight_id), 
	CONSTRAINT fk_res_pass_code FOREIGN KEY (reservation_code) REFERENCES reservations(reservation_code) ON UPDATE CASCADE ON DELETE CASCADE, 
	CONSTRAINT fk_res_pass_flight FOREIGN KEY (flight_id) REFERENCES flights(flight_id) ON UPDATE CASCADE ON DELETE CASCADE
); 
